---
date: 2009-01-28 02:17:38+00:00
layout: post
title: NetFlow V9 RFCいけてない
tags:
- コンピュータ＆ネットワーク
language:
- 日本語
---

NetFlow V9のRFC (3954) は、さすがにInformationalなRFCだけあって、いまいちだわ。。悩んでしまったゾ。

RFC3954によると、Options Template FlowSetのフォーマットは、

    
        0                   1                   2                   3
        0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |       FlowSet ID = 1          |          Length               |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |         Template ID           |      Option Scope Length      |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |        Option Length          |       Scope 1 Field Type      |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |     Scope 1 Field Length      |               ...             |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |     Scope N Field Length      |      Option 1 Field Type      |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |     Option 1 Field Length     |             ...               |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |     Option M Field Length     |           Padding             |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


となっていることから、Option Scopeは複数含めることができる事が分かる。

しかし、Option Data Record Formatのほうは、

    
        0                   1                   2                   3
        0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |    FlowSet ID = Template ID   |          Length               |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |   Record 1 - Scope 1 Value    |Record 1 - Option Field 1 Value|
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |Record 1 - Option Field 2 Value|             ...               |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |   Record 2 - Scope 1 Value    |Record 2 - Option Field 1 Value|
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |Record 2 - Option Field 2 Value|             ...               |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |   Record 3 - Scope 1 Value    |Record 3 - Option Field 1 Value|
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |Record 3 - Option Field 2 Value|             ...               |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |              ...              |            Padding            |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


という例が示されており、Scopeが1つしか入っていないケースしか示されていない。間違いではないがよい例ではないだろう。

本来は、

    
         0                   1                   2                   3
        0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |    FlowSet ID = Template ID   |          Length               |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |   Record 1 - Scope 1 Value    | 　 Record 1 - Scope 2 Value   |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |             ...               |Record 1 - Option Field 1 Value|
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |Record 1 - Option Field 2 Value|             ...               |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |   Record 2 - Scope 1 Value    | 　 Record 2 - Scope 2 Value   |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |             ...               |Record 2 - Option Field 1 Value|
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |Record 2 - Option Field 2 Value|             ...               |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |   Record 3 - Scope 1 Value    | 　 Record 3 - Scope 2 Value   |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |             ...               |Record 3 - Option Field 1 Value|
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |Record 3 - Option Field 2 Value|             ...               |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |   Record 3 - Scope 1 Value    | 　 Record 3 - Scope 2 Value   |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |             ...               |Record 3 - Option Field 1 Value|
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |Record 3 - Option Field 2 Value|             ...               |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
       |              ...              |            Padding            |
       +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+


とすべきだと思う。実際に1つのOption Templateに複数のScopeが含まれているTemplate FlowSetは見たことがないので、本当に上記のようになるのか確かめたことはないが、論理的に考えると上記のようになるはずである。また、Scopeが複数含まれていた場合のsemanticsもいまいちはっきりしない。

さすがに、IPFIXでは、このへんはすっきりしている。

    
       +--------------------------------------------------+
       | Template Record Header                           |
       +--------------------------------------------------+
       | Field Specifier                                  |
       +--------------------------------------------------+
       | Field Specifier                                  |
       +--------------------------------------------------+
        ...
       +--------------------------------------------------+
       | Field Specifier                                  |
       +--------------------------------------------------+


と

    
       +--------------------------------------------------+
       | Options Template Record Header                   |
       +--------------------------------------------------+
       | Field Specifier                                  |
       +--------------------------------------------------+
       | Field Specifier                                  |
       +--------------------------------------------------+
        ...
       +--------------------------------------------------+
       | Field Specifier                                  |
       +--------------------------------------------------+


のようにどちらも同じ枠組み（Field Specifier）で扱うことができるようになっている（もちろんTemplate Record HeaderとOption Template Record Headerは異なる）。また、複数のScopeが指定された場合のsemanticsについても言及されている。

InformationalなRFCと、Proposed StandardなRFCの成熟度の違いを見るにはとてもよい例だと思う。
